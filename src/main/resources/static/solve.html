<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>Doping Projesi - Test Çöz</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="container mt-5">

<script>
    // ✅ login kontrolü
    if (!localStorage.getItem("studentId")) {
        window.location.href = "login.html";
    }

    const selectedTestId = localStorage.getItem("selectedTestId");
    const studentTestId = localStorage.getItem("studentTestId");
    if (!selectedTestId || !studentTestId) {
        alert("Test bilgisi eksik! Test listesine dönülüyor.");
        window.location.href = "tests.html";
    }
</script>

<h2>Test Çöz</h2>
<form id="solveForm" class="mt-4"></form>
<button id="submitBtn" class="btn btn-success mt-3">Testi Gönder</button>

<div id="resultMsg" class="mt-4"></div>

<script>
async function loadQuestions() {
    const res = await fetch(`/tests/${selectedTestId}`);
    const test = await res.json();
    document.querySelector("h2").innerText = test.testName;

    const form = document.getElementById("solveForm");
    form.innerHTML = "";

    test.questions.forEach((q, idx) => {
        let html = `<div class="mb-3">
            <strong>${idx+1}. Soru: ${q.content}</strong><br>`;
        q.options.forEach(opt => {
            html += `<div class="form-check">
                <input class="form-check-input" type="radio" 
                    name="q${q.id}" value="${opt}" required>
                <label class="form-check-label">${opt}</label>
            </div>`;
        });
        html += `</div>`;
        form.innerHTML += html;
    });
}

document.getElementById("submitBtn").addEventListener("click", async () => {
    const form = document.getElementById("solveForm");
    const inputs = form.querySelectorAll("input[type=radio]:checked");

    const answers = {};
    inputs.forEach(input => {
        const qid = input.name.substring(1); // "q123" -> "123"
        answers[qid] = input.value;
    });

    const payload = {
        studentTestId: studentTestId,
        answers: answers
    };

    console.log("Gönderilen cevaplar:", payload);

    const res = await fetch("/student-tests/finish", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    if (res.ok) {
        alert("Test başarıyla gönderildi!");
        window.location.href = "results.html";
    } else {
        document.getElementById("resultMsg").innerText = "Test gönderilirken bir hata oluştu.";
    }
});

loadQuestions();
</script>
</body>
</html>
